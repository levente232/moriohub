{{#MORIO_DOCS}}
about: |-
  A filebeat module for Linux systems

  This collects log data from the Docker package when the logs are in JSON or tab-delimited text formats.

vars:
  defaults:
    MORIO_DOCKER_TEXT_LOGS_PATHS: "['/var/lib/docker/containers/*/*-json.log']"
    MORIO_DOCKER_SPLUNK_INDEX_NAME: false
  local:
    MORIO_DOCKER_TEXT_LOGS_PATHS: A (glob) list of paths from which to collect Apache access logs
    MORIO_DOCKER_SPLUNK_INDEX_NAME: If the logs are to be sent to a Splunk ecosystem, you can set this Morio variable to add a `splunk.index` field to the data, with the value of the variable.
{{/MORIO_DOCS}}

{{^MORIO_DOCS}}

- type: log
  id: docker_everything
  paths: {{MORIO_DOCKER_TEXT_LOGS_PATHS}}

  processors:
    - add_fields:
        target: morio
        fields:
          module: {{ MORIO_MODULE_NAME }}

    - add_fields:
        target: morio
        fields:
          module_version: "DO-AQ"

    - add_fields:
        target: host
        fields:
          id: {{ MORIO_CLIENT_UUID }}

    - add_id: null

    - add_fields:
        target: service
        fields:
          name: "Docker"

    - if:
        regexp:
          message: '^{"log":".*}$' # default Docker text log format
      then:
        - dissect:
            field: "message"
            tokenizer: "{\"log\":\"%{event.message}\",\"stream\":\"%{event.stream}\",\"time\":\"%{temp_timestamp}\"}"
            target_prefix: ''
            ignore_missing: true
            ignore_failure: true
            overwrite_keys: true
        - replace:
            fields:
              - field: "event.message"
                pattern: "\\\\u0009"
                replacement: "  "
            ignore_missing: true
            fail_on_error: false
        - add_fields:
            target: log
            fields:
              detected_format: "JSON"
      else:
        - dissect:
            field: "message"
            tokenizer: "%{temp_timestamp}\t%{client.ip}\t%{client.id}\t%{client.session_name}\t%{server.ip}\t%{event.message}"
            target_prefix: ''
            ignore_missing: true
            ignore_failure: true
            overwrite_keys: true
        - replace:
            fields:
              - field: "event.message"
                pattern: "\\t"
                replacement: "  "
            ignore_missing: true
            fail_on_error: false
        - add_fields:
            target: log
            fields:
              detected_format: "tab-delimited text"

    - timestamp:
        field: temp_timestamp
        layouts:
          - '2006-01-02T15:04:05.999999999Z'
          - '2006-01-02 15:04:05 -0700'
        timezone: Local
    - drop_fields:
        fields: temp_timestamp

    {{#MORIO_DOCKER_SPLUNK_INDEX_NAME }}
    - add_fields:
        target: splunk
        fields:
          index: {{ MORIO_DOCKER_SPLUNK_INDEX_NAME }}
    {{/MORIO_DOCKER_SPLUNK_INDEX_NAME }}

{{/MORIO_DOCS}}

