{{#MORIO_DOCS}}
about: |-
  A filebeat module for Linux systems

  This collects log data from the Zabbix package (both from the agent and from the server packages, if installed). 

  The path used as a default for agent logs is /var/log/zabbix-agent/zabbix_agentd.log.
  You can override the default value with the MORIO_ZABBIX_AGENT_LOGS_PATHS environment variable. If you do so, please make sure that it is formatted as a YAML directive starting by four (4) space characters and a dash as in the example below:
  ```
  # sudo morio vars set MORIO_ZABBIX_AGENT_LOGS_PATHS '    - /var/log/zabbix-agent/zabbix_agentd.log'
  ```

  The path used as a default for server logs is /var/log/zabbix/zabbix_server.log.
  You can override the default value with the MORIO_ZABBIX_SERVER_LOGS_PATHS environment variable and the same syntax rules apply.

  If the logs are to be sent to a Splunk ecosystem, you can set the MORIO_ZABBIX_SPLUNK_INDEX_NAME Morio variable to specify the name of the Splunk index to use.
{{/MORIO_DOCS}}

{{^MORIO_DOCS}}

- type: log # Zabbix agent logs
  id: zabbix_agent
  paths:
{{#MORIO_ZABBIX_AGENT_LOGS_PATHS}}
{{MORIO_ZABBIX_AGENT_LOGS_PATHS}}
{{/MORIO_ZABBIX_AGENT_LOGS_PATHS}}
{{^MORIO_ZABBIX_AGENT_LOGS_PATHS}}
    - /var/log/zabbix-agent/zabbix_agentd.log
{{/MORIO_ZABBIX_AGENT_LOGS_PATHS}}

  processors:
    - add_fields:
        target: morio
        fields:
          module: {{ MORIO_MODULE_NAME }}

    - add_fields:
        target: host
        fields:
          id: {{ MORIO_CLIENT_UUID }}

    - add_fields:
        target: debug
        fields:
          iteration: "ZA-AI"

    - if:
        regexp:
          message: '^[ \d]+:\d{8}:\d{6}.\d{3}\s' # default log format
      then:
        - dissect:
            field: "message"
            tokenizer: "%{process.pid}:%{temp_timestamp} %{event.message}"
            target_prefix: ''
            ignore_missing: true
            ignore_failure: true
            overwrite_keys: true
            trim_values: left # as the PID can have spaces
        - add_fields:
            target: log
            fields:
              detected_format: "default"
        - add_fields:
            target: event
            fields:
              type: "agent"
        - add_fields:
            target: service
            fields:
              name: "Zabbix Agent"

    - timestamp:
        field: temp_timestamp
        layouts:
          - '20060102:150405.999'
        timezone: Local
    - drop_fields:
        fields: temp_timestamp


- type: log # Zabbix server logs
  id: zabbix_server
  paths:
{{#MORIO_ZABBIX_SERVER_LOGS_PATHS}}
{{MORIO_ZABBIX_SERVER_LOGS_PATHS}}
{{/MORIO_ZABBIX_SERVER_LOGS_PATHS}}
{{^MORIO_ZABBIX_SERVER_LOGS_PATHS}}
    - /var/log/zabbix/zabbix_server.log
{{/MORIO_ZABBIX_SERVER_LOGS_PATHS}}

  processors:
    - add_fields:
        target: morio
        fields:
          module: {{ MORIO_MODULE_NAME }}

    - add_fields:
        target: host
        fields:
          id: {{ MORIO_CLIENT_UUID }}

    - add_fields:
        target: debug
        fields:
          iteration: "ZS-AA"

    - if:
        regexp:
          message: '^[ \d]+:\d{8}:\d{6}.\d{3}\s' # default log format
      then:
        - dissect:
            field: "message"
            tokenizer: "%{process.pid}:%{temp_timestamp} %{event.message}"
            target_prefix: ''
            ignore_missing: true
            ignore_failure: true
            overwrite_keys: true
            trim_values: left # as the PID can have spaces
        - add_fields:
            target: log
            fields:
              detected_format: "default"
        - add_fields:
            target: event
            fields:
              type: "server"
        - add_fields:
            target: service
            fields:
              name: "Zabbix Server"

    - timestamp:
        field: temp_timestamp
        layouts:
          - '20060102:150405.999'
        timezone: Local
    - drop_fields:
        fields: temp_timestamp

    {{#MORIO_ZABBIX_SPLUNK_INDEX_NAME }}
    - add_fields:
        target: splunk
        fields:
          index: {{ MORIO_ZABBIX_SPLUNK_INDEX_NAME }}
    {{/MORIO_ZABBIX_SPLUNK_INDEX_NAME }}

{{/MORIO_DOCS}}

